<?php

namespace App\Http\Controllers;

use App\Mail\LeadSessionReminder;
use App\Mail\ParticipantSessionReminder;
use App\Mail\SendEmail;
use App\Mail\SessionLeadRequestMail;
use App\Mail\SessionReminderMail;
use App\Mail\SlotBookingCancellation;
use App\Mail\SlotBookingConfirmation;
use App\Models\BookingHistory;
use App\Models\SessionEmailJob;
use App\Models\SessionLeads;
use App\Models\Slot;
use App\Models\User;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Mail;

class MemberController extends Controller
{
    /**
     * Create a new controller instance.
     *
     * @return void
     */
    // public function __construct()
    // {
    //     $this->middleware('auth');
    // }

    /**
     * Show the application dashboard.
     *
     * @return \Illuminate\Contracts\Support\Renderable
     */
    public function dashboard()
    {
        return view('frontend.members.dashboard');
    }

    public function howtousethissite()
    {
        return view('frontend.howtousethissite');
    }

    public function user_dashboard()
    {
        $userId = Auth::id();

        $approvedSlotCount = SessionLeads::with('slot')->where('status', 1)->where('user_id', $userId)->count();

        $pendingSlotCount = SessionLeads::with('slot')->where('status', 0)->where('user_id', $userId)->count();

        $recentleadsessions = SessionLeads::with('slot')->where('status', 1)->where('user_id', $userId)->limit('5')->get();

        $recentBookings = BookingHistory::with('slot')->where('user_id', $userId)->where('status', 1)->limit('5')->get();
        return view('frontend.members.user_dashboard', compact('recentleadsessions', 'recentBookings', 'approvedSlotCount', 'pendingSlotCount'));
    }

    public function change_password()
    {
        // Retrieve the authenticated user
        $user = Auth::user();

        // Pass the user data to the view
        return view('frontend.members.change_password', compact('user'));
    }

    public function updatePassword(Request $request, $id)
    {
        $validatedData = $request->validate([
            'current_password' => 'required',
            'new_password' => 'required|min:8',
            'confirm_password' => 'required|same:new_password',
        ]);

        $user = User::findOrFail($id);

        if (!Hash::check($validatedData['current_password'], $user->password)) {
            return back()->withErrors(['current_password' => 'The current password is incorrect.']);
        }

        $user->password = Hash::make($validatedData['new_password']);
        $user->save();

        return redirect()->route('changepassword')->with('success', 'Password updated successfully.');
    }

    public function updateprofile(Request $request, $id)
    {
        $validatedData = $request->validate([
            'name' => 'required',
            'email' => 'required|email',
            'laboratory_name' => 'nullable'
        ]);

        $user = User::findOrFail($id);

        if ($request->hasFile('image')) {
            $imageExtension = $request->file('image')->getClientOriginalExtension();
            $imageName = 'image_' . time() . '.' . $imageExtension;
            $request->file('image')->move(public_path('/admin/assets/images/'), $imageName);
            $user->image = $imageName;
        }

        $user->laboratory_name = $validatedData['laboratory_name'];
        $user->name = $validatedData['name'];
        $user->email = $validatedData['email'];

        $user->save();

        return redirect()->route('userprofile')->with('success', 'Profile updated successfully.');
    }

    public function unregister($id)
    {
        $user = User::findOrFail($id);

        // Soft delete the user
        $user->delete();

        // Log out the user
        Auth::logout();

        // Redirect to the homepage with a success message
        return redirect('/')->with('success', 'Your account has been deleted, and you have been logged out.');
    }

    public function checkActiveSlots()
    {
        $userId = Auth::user()->id;
        $activeSlot = SessionLeads::where('user_id', $userId)
            ->where('status', '1')
            ->exists();
        return response()->json(['has_active_slot' => $activeSlot]);
    }

    public function userprofile()
    {
        $user = Auth::user();

        return view('frontend.members.userprofile', compact('user'));
    }

    public function leadmanagement(Request $request)
    {
        $userId = Auth::id();

        // Get dates from request
        $fromDate = $request->input('from_date');
        $toDate = $request->input('to_date');

        $query = Slot::whereHas('sessionLeads', function ($query) use ($userId) {
            $query->where('user_id', $userId);
        });

        if ($fromDate && $toDate) {
            $query->whereBetween('date', [$fromDate, $toDate]);
        }
        $slots = $query->with([
            'sessionLeads' => function ($query) use ($userId) {
                $query->where('user_id', $userId);
            }
        ])->get();

        return view('frontend.members.leadmanagement', compact('slots'));
    }

    public function mySessions(Request $request)
    {
        $userId = Auth::id();

        $fromDate = $request->input('from_date');
        $toDate = $request->input('to_date');

        // --------- Lead Sessions ---------
        $leadQuery = Slot::whereHas('sessionLeads', function ($q) use ($userId) {
            $q->where('user_id', $userId);
        });

        if ($fromDate && $toDate) {
            $leadQuery->whereBetween('date', [$fromDate, $toDate]);
        }

        $leadSlots = $leadQuery->with([
            'sessionLeads' => function ($q) use ($userId) {
                $q->where('user_id', $userId);
            }
        ])->get()->map(function ($slot) {
            $slot->role = 'Leader';
            $slot->status = $slot->sessionLeads->first()->status ?? 0;
            $slot->description = $slot->sessionLeads->first()->description ?? '';
            return $slot;
        });

        // --------- Participant Sessions ---------
        $bookedSlots = BookingHistory::with('slot')
            ->where('user_id', $userId)
            ->where('status', 1)
            ->get()
            ->filter(fn($booking) => $booking->slot)
            ->map(function ($booking) {
                $slot = $booking->slot;
                $slot->role = 'Participant';
                $slot->status = 1;
                $slot->description = $slot->description ?? '';
                $slot->booking_id = $booking->id;  // <-- attach booking ID for cancel route
                return $slot;
            });

        // Merge and sort
        $allSlots = $leadSlots->merge($bookedSlots)->sortByDesc('date');

        return view('frontend.members.mysession', compact('allSlots', 'fromDate', 'toDate'));
    }

    public function store(Request $request)
    {
        try {
            // Validate input
            $validated = $request->validate([
                'slot_id' => 'required|exists:slots,id',
                'agenda' => 'required|string|max:255',
                'description' => 'required|string',
                'other_details' => 'nullable|string',
            ]);

            // Save session lead
            SessionLeads::create([
                'user_id' => auth()->id(),
                'slot_id' => $validated['slot_id'],
                'agenda' => $validated['agenda'],
                'description' => $validated['description'],
                'other_details' => $validated['other_details'],
            ]);

            $slot = Slot::find($validated['slot_id']);
            $user = User::find(auth()->id());

            // Prepare mail content
            $agenda = $validated['agenda'];
            $description = $validated['description'];
            $otherDetails = $validated['other_details'] ?? 'N/A';

            // Get all admin users
            $admins = User::where('role', 1)->get();

            foreach ($admins as $admin) {
                Mail::to($admin->email)->send(
                    new SessionLeadRequestMail($user, $slot, $agenda, $description, $otherDetails)
                );
            }

            return response()->json(['success' => true, 'message' => 'Slot booked and admin notified.']);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'message' => $e->getMessage()]);
        }
    }

    public function checkSlotStatus(Request $request)
    {
        $slot = Slot::find($request->slot_id);

        if (!$slot) {
            return response()->json(['success' => false, 'message' => 'Slot not found.']);
        }

        if ($slot->status == 1) {
            return response()->json(['success' => false, 'message' => 'This slot has already been booked.']);
        }

        return response()->json(['success' => true]);
    }

    public function availableslots(Request $request)
    {
        $userId = Auth::id();

        try {
            // Check if dates are provided or fetch all records
            $fromDate = $request->input('from_date')
                ? Carbon::createFromFormat('m-d-Y', $request->input('from_date'))->format('Y-m-d')
                : null;

            $toDate = $request->input('to_date')
                ? Carbon::createFromFormat('m-d-Y', $request->input('to_date'))->format('Y-m-d')
                : null;
        } catch (\Exception $e) {
            return back()->withErrors(['error' => 'Invalid date format provided.']);
        }

        // Build the query
        $query = Slot::with([
            'sessionLeads' => function ($query) use ($userId) {
                $query->where('user_id', $userId)->where('status', 0);
            }
        ])->where('status', 0);

        // Apply date filters if provided
        // if ($fromDate && $toDate) {
        //     $query->whereBetween('date', [$fromDate, $toDate]);
        // }

        // Fetch results
        $slots = $query->get();

        return view('frontend.members.availableslots', compact('slots'));
    }

    public function book_session_list(Request $request)
    {
        $userId = Auth::id();

        try {
            // Parse incoming dates or set defaults
            $fromDate = $request->input('from_date')
                ? Carbon::createFromFormat('m-d-Y', $request->input('from_date'))->format('Y-m-d')
                : null;

            $toDate = $request->input('to_date')
                ? Carbon::createFromFormat('m-d-Y', $request->input('to_date'))->format('Y-m-d')
                : null;
        } catch (\Exception $e) {
            return back()->withErrors(['error' => 'Invalid date format provided.']);
        }

        // Query slots without existing bookings for the current user
        $query = Slot::where('status', 1)
            ->whereDoesntHave('booking_history', function ($query) use ($userId) {
                $query->where('user_id', $userId)->where('status', 1);
            });

        // Apply date filters if provided
        if ($fromDate && $toDate) {
            $query->whereBetween('date', [$fromDate, $toDate]);
        }

        // Fetch results
        $slots = $query->get();

        return view('frontend.members.bookinglist', compact('slots'));
    }

    public function bookingHistorylist(Request $request)
    {
        $userId = Auth::id();

        // Build the query
        $query = Slot::whereHas('bookinghistory', function ($query) use ($userId) {
            $query->where('user_id', $userId)->where('status', 1);
        })->where('status', '!=', 1);

        $slots = BookingHistory::with('slot')->where('user_id', $userId)->where('status', 1)->get();
        // dd($slots);
        return view('frontend.members.bookingHistorylist', compact('slots'));
    }

    public function cancelBookingById($id, $slot_id)
    {
        $bookingHistory = BookingHistory::where([
            ['user_id', Auth::user()->id],
            ['id', $id],
        ])->first();

        if ($bookingHistory) {
            $bookingHistory->delete();

            // Send cancellation email
            $user = Auth::user();
            $slot = Slot::with('sessionLeads')->find($slot_id);

            if ($slot) {
                Mail::to($user->email)->send(new SlotBookingCancellation($user, $slot));
            }

            $pendingBooking = BookingHistory::where([
                ['slot_id', $slot_id],
                ['status', 2],
            ])->orderBy('created_at', 'asc')->first();

            if ($pendingBooking) {
                $pendingBooking->status = 1;
                $pendingBooking->save();

                $session_lead = SessionLeads::where('slot_id', $slot_id)->where('status', 1)->first();

                // $emailData = [
                //     'user' => User::find($pendingBooking->user_id),
                //     'slot_id' => $slot_id,
                //     'agenda' => $session_lead->agenda,
                //     'description' => $session_lead->description,
                //     'other_details' => $session_lead->other_details,
                // ];

                // Send email
                // Mail::to('recipient@example.com')->send(new SendEmail($emailData));
            }

            return redirect()->route('user.my_sessions')->with('success', 'Booking canceled successfully.');
        } else {
            return redirect()->route('user.my_sessions')->withErrors(['error' => 'Booking not found.']);
        }
    }

    public function bookasession(Request $request)
    {
        $request->validate([
            'slot_id' => 'required|exists:slots,id',
        ]);

        $userId = Auth::id();

        $existingBooking = BookingHistory::where('slot_id', $request->slot_id)
            ->where('user_id', $userId)
            ->where('status', 0)
            ->first();

        if ($existingBooking) {
            return response()->json(['success' => false, 'message' => 'You have already booked this slot.'], 400);
        }

        $slot = Slot::find($request->slot_id);
        if (!$slot) {
            return back()->withErrors(['error' => 'Slot not found.']);
        }

        // Count total bookings for the slot
        $currentBookings = BookingHistory::where('slot_id', $request->slot_id)->count();

        // Check if available slots are less than max allowed
        if ($currentBookings >= $slot->no_of_attendees) {
            // Check if the user already booked the slot
            $existingBooking = BookingHistory::where('slot_id', $request->slot_id)
                ->where('user_id', $userId)
                ->first();

            if ($existingBooking) {
                return response()->json([
                    'success' => false,
                    'message' => 'You have already booked this slot.'
                ], 409);  // 409 Conflict
            }

            // Create a new booking if not already booked
            $booking = BookingHistory::create([
                'slot_id' => $request->slot_id,
                'user_id' => $userId,
                'status' => 2,  // Marked as pending
            ]);

            return response()->json([
                'success' => true,
                'markas' => '2',
                'message' => 'Slot successfully booked and marked as pending.'
            ], 200);
        }

        // Create a new booking history record
        $booking = BookingHistory::create([
            'slot_id' => $request->slot_id,
            'user_id' => $userId,
            'status' => 1,  // 0 for booked
        ]);

        $user = auth()->user();

        // Send email
        Mail::to($user->email)->send(new SlotBookingConfirmation($user, $slot));

        // Optionally, you could update the Slot status if needed
        // $slot = Slot::find($request->slot_id);
        // if ($slot) {
        //     $slot->status = 1;
        //     $slot->save();
        // }

        // Return a response with success message
        return response()->json(['success' => true, 'markas' => '1', 'message' => 'Booking confirmed successfully!'], 200);
    }
}
